javascript:(function(){
  if(window.linkZenInitialized) return alert('LinkZen già attivo');
  window.linkZenInitialized = true;

  window.data = {
    categories: {
      'Uncategorized': []
    }
  };
  window.undoStack = [];

  function saveData() {
    localStorage.setItem('linkZenData', JSON.stringify(window.data.categories));
  }

  function loadData() {
    try {
      const d = JSON.parse(localStorage.getItem('linkZenData'));
      if(d && typeof d === 'object') window.data.categories = d;
    } catch {}
  }

  function pushUndo() {
    window.undoStack.push(JSON.stringify(window.data.categories));
    if(window.undoStack.length > 20) window.undoStack.shift();
  }

  function undo() {
    if(window.undoStack.length) {
      window.data.categories = JSON.parse(window.undoStack.pop());
      saveData();
      renderAll();
    } else alert('Niente da annullare');
  }

  function addCategory(name){
    if(!name || window.data.categories[name]) return alert('Categoria già esistente o nome non valido');
    pushUndo();
    window.data.categories[name] = [];
    saveData();
    renderAll();
  }

  function removeCategory(name){
    if(name === 'Uncategorized') return alert('Categoria "Uncategorized" non può essere rimossa.');
    if(!window.data.categories[name]) return;
    if(window.data.categories[name].length > 0) return alert('La categoria non è vuota, sposta prima i link.');
    pushUndo();
    delete window.data.categories[name];
    saveData();
    renderAll();
  }

  function exportData(){
    const json = JSON.stringify(window.data.categories,null,2);
    const blob = new Blob([json],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'linkzen_data.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importData(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imp = JSON.parse(e.target.result);
        if(typeof imp !== 'object') throw new Error('File non valido');
        pushUndo();
        window.data.categories = imp;
        saveData();
        renderAll();
      } catch {
        alert('File JSON non valido');
      }
    };
    reader.readAsText(file);
  }

  window.currentZoom = 1;

  function setZoom(z){
    window.currentZoom = Math.min(Math.max(z,0.5),3);
    const container = document.getElementById('linkZenContainer');
    if(container) container.style.fontSize = window.currentZoom + 'em';
    localStorage.setItem('linkZenZoom', window.currentZoom);
  }

  function zoomIn(){ setZoom(window.currentZoom + 0.1); }
  function zoomOut(){ setZoom(window.currentZoom - 0.1); }
  function resetZoom(){ setZoom(1); }

  function loadZoom(){
    const saved = localStorage.getItem('linkZenZoom');
    if(saved) setZoom(parseFloat(saved));
  }

  function toggleDarkMode(enable){
    if(enable === undefined) enable = !document.body.classList.contains('dark-mode');
    if(enable) document.body.classList.add('dark-mode');
    else document.body.classList.remove('dark-mode');
    localStorage.setItem('linkZenDarkMode', enable ? '1' : '0');
  }

  function loadDarkMode(){
    if(localStorage.getItem('linkZenDarkMode') === '1') toggleDarkMode(true);
  }

  function setupEasterEgg(){
    const seq = ['l','i','n','k','z','e','n'];
    let pos = 0;
    window.addEventListener('keydown', e => {
      if(e.key.toLowerCase() === seq[pos]) pos++;
      else pos = 0;
      if(pos === seq.length){
        pos = 0;
        triggerEasterEgg();
      }
    });
  }

  function triggerEasterEgg(){
    const b = document.body;
    const orig = b.style.backgroundColor;
    b.style.backgroundColor = '#FFD700';
    setTimeout(()=>{ b.style.backgroundColor = orig; }, 2000);
  }

  function renderAll() {
    let container = document.getElementById('linkZenContainer');
    if(!container) {
      container = document.createElement('div');
      container.id = 'linkZenContainer';
      Object.assign(container.style, {
        position:'fixed', top:'10px', right:'10px', 
        width:'320px', height:'400px', 
        overflow:'auto', background:'#fff', 
        border:'1px solid #ccc', padding:'10px', 
        zIndex:999999, fontSize: (window.currentZoom||1)+'em',
        fontFamily:'Arial,sans-serif',
        boxShadow:'0 0 10px rgba(0,0,0,0.3)',
        backgroundColor: document.body.classList.contains('dark-mode') ? '#222' : '#fff',
        color: document.body.classList.contains('dark-mode') ? '#ddd' : '#000'
      });
      document.body.appendChild(container);
    }
    container.innerHTML = '<h3>LinkZen</h3>';

    for(let cat in window.data.categories){
      const links = window.data.categories[cat];
      const catDiv = document.createElement('div');
      catDiv.style.marginBottom = '10px';

      const catTitle = document.createElement('div');
      catTitle.textContent = cat + ' ('+links.length+') ';
      catTitle.style.fontWeight = 'bold';

      const removeCatBtn = document.createElement('button');
      removeCatBtn.textContent = '✖';
      removeCatBtn.title = 'Rimuovi categoria';
      removeCatBtn.style.marginLeft = '8px';
      removeCatBtn.onclick = ()=>removeCategory(cat);
      if(cat==='Uncategorized') removeCatBtn.disabled = true;

      catTitle.appendChild(removeCatBtn);
      catDiv.appendChild(catTitle);

      const ul = document.createElement('ul');
      ul.style.paddingLeft = '15px';
      links.forEach((l,i)=>{
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = l.url;
        a.textContent = l.title || l.url;
        a.target = '_blank';
        li.appendChild(a);

        const del = document.createElement('button');
        del.textContent = '✖';
        del.title = 'Rimuovi link';
        del.style.marginLeft = '6px';
        del.onclick = function(){
          pushUndo();
          links.splice(i,1);
          saveData();
          renderAll();
        };
        li.appendChild(del);
        ul.appendChild(li);
      });
      catDiv.appendChild(ul);

      // Form per aggiungere link in categoria
      const addForm = document.createElement('form');
      addForm.style.marginTop = '5px';

      const inputUrl = document.createElement('input');
      inputUrl.type = 'text';
      inputUrl.placeholder = 'Nuovo URL';
      inputUrl.style.width = '70%';
      inputUrl.required = true;

      const inputTitle = document.createElement('input');
      inputTitle.type = 'text';
      inputTitle.placeholder = 'Titolo (opzionale)';
      inputTitle.style.width = '25%';
      inputTitle.style.marginLeft = '5px';

      const addBtn = document.createElement('button');
      addBtn.textContent = 'Aggiungi';
      addBtn.type = 'submit';
      addBtn.style.marginLeft = '4px';

      addForm.appendChild(inputUrl);
      addForm.appendChild(inputTitle);
      addForm.appendChild(addBtn);

      addForm.onsubmit = function(e){
        e.preventDefault();
        const url = inputUrl.value.trim();
        const title = inputTitle.value.trim();
        if(!url) return alert('Inserisci URL');
        pushUndo();
        links.push({url,title});
        saveData();
        renderAll();
      };

      catDiv.appendChild(addForm);
      container.appendChild(catDiv);
    }

    // Controlli globali
    const controlsDiv = document.createElement('div');
    controlsDiv.style.borderTop = '1px solid #ccc';
    controlsDiv.style.paddingTop = '8px';

    const addCatBtn = document.createElement('button');
    addCatBtn.textContent = 'Nuova categoria';
    addCatBtn.onclick = () => {
      const name = prompt('Nome nuova categoria');
      if(name) addCategory(name.trim());
    };
    controlsDiv.appendChild(addCatBtn);

    const undoBtn = document.createElement('button');
    undoBtn.textContent = 'Annulla';
    undoBtn.style.marginLeft = '8px';
    undoBtn.onclick = undo;
    controlsDiv.appendChild(undoBtn);

    const exportBtn = document.createElement('button');
    exportBtn.textContent = 'Esporta JSON';
    exportBtn.style.marginLeft = '8px';
    exportBtn.onclick = exportData;
    controlsDiv.appendChild(exportBtn);

    let importInput = document.getElementById('linkZenImportInput');
    if(!importInput){
      importInput = document.createElement('input');
      importInput.type = 'file';
      importInput.id = 'linkZenImportInput';
      importInput.accept = '.json,application/json';
      importInput.style.display = 'none';
      importInput.onchange = (e) => {
        importData(e.target.files[0]);
        e.target.value = '';
      };
      document.body.appendChild(importInput);
    }
    const importBtn = document.createElement('button');
    importBtn.textContent = 'Importa JSON';
    importBtn.style.marginLeft = '8px';
    importBtn.onclick = () => importInput.click();
    controlsDiv.appendChild(importBtn);

    const zoomInBtn = document.createElement('button');
    zoomInBtn.textContent = 'Zoom +';
    zoomInBtn.style.marginLeft = '8px';
    zoomInBtn.onclick = zoomIn;
    controlsDiv.appendChild(zoomInBtn);

    const zoomOutBtn = document.createElement('button');
    zoomOutBtn.textContent = 'Zoom -';
    zoomOutBtn.style.marginLeft = '4px';
    zoomOutBtn.onclick = zoomOut;
    controlsDiv.appendChild(zoomOutBtn);

    const zoomResetBtn = document.createElement('button');
    zoomResetBtn.textContent = 'Reset Zoom';
    zoomResetBtn.style.marginLeft = '4px';
    zoomResetBtn.onclick = resetZoom;
    controlsDiv.appendChild(zoomResetBtn);

    const darkToggleBtn = document.createElement('button');
    darkToggleBtn.textContent = document.body.classList.contains('dark-mode') ? 'Light Mode' : 'Dark Mode';
    darkToggleBtn.style.marginLeft = '8px';
    darkToggleBtn.onclick = () => {
      toggleDarkMode();
      darkToggleBtn.textContent = document.body.classList.contains('dark-mode') ? 'Light Mode' : 'Dark Mode';
      renderAll();
    };
    controlsDiv.appendChild(darkToggleBtn);

    container.appendChild(controlsDiv);
  }

  // Avvio
  loadData();
  loadZoom();
  loadDarkMode();
  renderAll();
  setupEasterEgg();
})();
